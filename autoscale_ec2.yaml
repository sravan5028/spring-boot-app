---
  - name: Provision an EC2 Instance with autoscaling groups
    hosts: localhost
    connection: local
    gather_facts: False
    vars:
      keypair: ansi
      instance_type: t2.micro
      image: ami-0080e4c5bc078760e 
      region: us-east-1
    tasks:
    - name: create Launch conf
      ec2_lc:
        name: new_lc2
        key_name: "{{ keypair }}"
        security_groups: sg-065a45ef55df6bc84
        instance_type: "{{ instance_type }}"
        image_id: "{{ image }}"
        user_data: "{{ lookup('file','user_data.sh')}}"
        region: "{{ region }}"
        instance_profile_name: s3-mybucket-role
        vpc_id: vpc-0fe8a4bacb6ea904c
        assign_public_ip: yes
        state: present
      register: ec2
    - name: create autoscaling groups
      ec2_asg:
        name: myasg
        launch_config_name: new_lc2
        target_group_arns: arn:aws:elasticloadbalancing:us-east-1:266734962886:targetgroup/alb-target-group/eddeb40828ac5a63
        health_check_period: 500
        health_check_type: EC2
        wait_for_instances: yes
        wait_timeout: 300
        replace_all_instances: yes
        min_size: 2
        max_size: 5
        desired_capacity: 3
        region: us-east-1
        vpc_zone_identifier: [ 'subnet-0992aeabcdc677b1b', 'subnet-0eb977b9e05eec3c9' ]
        state: present
        tags:
          - environment: stable
            propagate_at_launch: no
