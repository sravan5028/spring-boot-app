---
  - name: Provision an EC2 Instance
    hosts: ansible-server
    connection: local
    gather_facts: False
    vars:
      keypair: windows
      instance_type: t2.micro
      image: ami-0ac019f4fcb7cb7e6
      region: us-east-1
    tasks:
    - name: Launch instance
      ec2:
         key_name: "{{ keypair }}"
         group_id: sg-043b966dd24df94d7
         instance_type: "{{ instance_type }}"
         image: "{{ image }}"
         wait: true
         region: "{{ region }}"
         vpc_subnet_id: subnet-0910cfbf52368fbad
         instance_profile_name: s3-mybucket-role
         assign_public_ip: yes
      register: ec2
    
    - name: Touch a host file
      local_action: file
            path=/tmp/hosts_dev
            state=absent
                
    - name: Touch a host file
      local_action: file
                    path=/tmp/hosts_dev
                    state=touch
                    mode="u=rw,g=r,o=r"


    - name: Add the newly created EC2 instance(s) to the local host group (located inside the directory)
      local_action: lineinfile 
                    dest="/tmp/hosts_dev" 
                    state=present
                    regexp={{ item.public_ip }} 
                    line="{{ item.public_ip }} ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
      with_items: "{{ ec2.instances }}"


    - name: Wait for SSH to come up
      local_action: wait_for 
                    host={{ item.public_ip }} 
                    port=22 
                    state=started
      with_items: "{{ ec2.instances }}"

    - name: Add tag to Instance(s)
      local_action: ec2_tag resource={{ item.id }} region="us-east-1" state=present
      with_items: "{{ ec2.instances }}"
      args:
        tags:
          Name: dev
